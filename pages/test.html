<!DOCTYPE html>
<html lang="nl">
    <head>
        <title>MAP_Verbeke_Pre-Test</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="../jspsych/jspsych.js"></script>
        <script src="../jspsych/plugins/jspsych-audio-keyboard-response.js"></script>
        <script src="../jspsych/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="../jspsych/plugins/jspsych-html-button-response.js"></script>
        <script src="../jspsych/plugins/jspsych-instructions.js"></script>
        <script src="../js/Practice_Trials.js"></script>
        <script src="../js/MAP_LDT_Stimuli_v1.js"></script>
        <script src="../js/MAP_LDT_Stimuli_v2.js"></script>
        <script src="../js/MAP_PCT_Stimuli_v1.js"></script>
        <script src="../js/MAP_PCT_Stimuli_v2.js"></script>
        <script src="../js/functions.js"></script>
        <link href="../jspsych/css/jspsych.css" rel="stylesheet">
    </head>
    <body>
    </body>
    <script>    
        var timeline = [];
        // create list of all audio files for preloading
        var all_audio = [];

        for (var i = 0; i < LDT_practice_trial.length; i++) {
            all_audio.push(LDT_practice_trial[i].target_audio);//!
        }
        for (var i = 0; i < lex_dec_stim_v1.length; i++) {
            all_audio.push(lex_dec_stim_v1[i].target_audio);//!
        }
        // for (var i = 0; i < lex_dec_stim_v2.length; i++) {
        //     all_audio.push(lex_dec_stim_v2[i].target_audio);//!
        // }
        for (var i = 0; i < phon_cat_stim_v1.length; i++) {
            all_audio.push(phon_cat_stim_v1[i].target_audio);//!
        }
        for (var i = 0; i < phon_cat_stim_v2.length; i++) {
            all_audio.push(phon_cat_stim_v2[i].target_audio);//!
        }

        //randomizeSounds();
        randomizeSoundsTrial1(lex_dec_stim_v1); 

        var instructions = {
            type: 'instructions',
            pages: [
                "<p>Druk op <b>'next'</b> om door te gaan naar de instructies.</p>",
                '<div style="max-width:675px;"><p>In het eerste deel van het experiment zul je een reeks zinnetjes horen waarbij telkens één woord verschilt. Het is de bedoeling dat je aangeeft of dat woord als dan niet bestaat in het Nederlands.'+
                "<p>Hoor je bijvoorbeeld het woord <b>appel</b> zoals in <i>Ze heeft <u>appel</u> gezegd.</i>, druk dan op de <b>J-toets</b></p>"+
                "<p>Hoor je bijvoorbeeld het niet-woord <b>krasp</b> zoals in <i>Ze heeft <u>krasp</u> gezegd.</i>, druk dan op de <b>F-toets</b></p>",
                '<p>Ter herinnering zal telkens herhaald worden welke toets met welk soort woord geassocieerd is.</p>'+
                '<p>Merk op: niet alleen de <b>snelheid</b> maar ook de <b>nauwkeurigheid</b> van je antwoord is van belang.</p>'+
                '<p>Dit eerste deel duurt ongeveer XX minuten, pauze meegerekend.</p>',
                '<p>Vooraleer het experiment te starten, kun je een aantal oefenvoorbeelden maken. In plaats van een gesproken zinnetje zal een geschreven zinnetje op het scherm verschijnen.</p>'+
                '<p>Het is de bedoeling dat je aangeeft of het woord een bestaand of niet-bestaand woord is door op de corresponderende toets te drukken.</p>'+
                '<p>Na de oefenfase start het experiment met de gesproken zinnetjes.</p>',
            ],
            show_clickable_nav: true,
        };
        timeline.push(instructions);

        var practice_fixation = {
            type: 'html-keyboard-response',
            stimulus: '<span style="font-size:40px;">+</span>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000
        };
        var practice_target = {
            type: 'audio-keyboard-response', //I think this is the place where the name of the newly created plugin should go
            stimulus: jsPsych.timelineVariable('target_audio'),
            prompt: '<span style="font-size:40px;">+</span>',
            choices: jsPsych.NO_KEYS,
            response_allowed_while_playing: false,
            trial_ends_after_audio: true,
            autoplay: true,
            data: {
                target: jsPsych.timelineVariable('target'),
                probe: jsPsych.timelineVariable('probe'),
                condition: jsPsych.timelineVariable('condition'),
                trial_part: 'target'
            }
        }; 
        var practice_lexical_decision_trial = {
            type: 'html-keyboard-response',
            stimulus: function() {
                return '<span style="font-size:40px;">' + jsPsych.timelineVariable('probe', true) + '</span>';
            },
            choices: ['f','j'],
            stimulus_duration: 3000,	
            data: {
                condition: jsPsych.timelineVariable('condition'), 
                correct_response: jsPsych.timelineVariable('correct_response')
            },
            post_trial_gap: 1000,
            on_finish: function(data) {
                var acc = false;
                if (data.correct_response == jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press)) {
                    acc = true;
                }
                data.accuracy = acc;
            }
        };
        var practice_feedback = {
            type: 'html-keyboard-response',
            stimulus: function() {
                var feedback_text = '<span style="font-size:30px;color:red;">Incorrect</span>';
                var last_trial_accuracy = jsPsych.data.getLastTrialData().values()[0].accuracy; 
                if (last_trial_accuracy == true) {
                    feedback_text = '<span style="font-size:30px;color:green;">Correct!</span>'
                }
                return feedback_text;
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: 3000
        };
        var practice_trials = {
            timeline: [practice_fixation, practice_target, practice_lexical_decision_trial, practice_feedback],
            timeline_variables: LDT_practice_trial,
        };
        timeline.push(practice_trials);

        var start_task = {
            type: 'html-button-response',
            stimulus: "De oefenfase is nu afgerond. Klik op <b>'Start'</b> om aan het echte experiment te beginnen.", 
            choices: ['Start'],
            response_ends_trial: true,
            post_trial_gap: 1000
        };
        timeline.push(start_task);

        var fixation = {
            type: 'html-keyboard-response',
            stimulus: '<span style="font-size:40px;">+</span>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            data: {
                trial_part: 'fixation'            
            }
        };

        var target = {
            type: 'audio-keyboard-response', //I think this is the place where the name of the newly created plugin should go
            stimulus: jsPsych.timelineVariable('target_audio'),
            prompt: '<span style="font-size:40px;">+</span>',
            choices: jsPsych.NO_KEYS,
            response_allowed_while_playing: false,
            trial_ends_after_audio: true,
            autoplay: true,
            data: {
                target: jsPsych.timelineVariable('target'),
                probe: jsPsych.timelineVariable('probe'),
                condition: jsPsych.timelineVariable('condition'),
                trial_part: 'target'
            }
        }; 

        var probe = {
            type: 'html-keyboard-response',
            stimulus: function() {
                return '<span style="font-size:40px;">' + jsPsych.timelineVariable('probe', true) + '</span>';
            },
            choices: ['f', 'j'],
            post_trial_gap: 500,
            response_ends_trial: true,
            data: {
                target: jsPsych.timelineVariable('target'),
                probe: jsPsych.timelineVariable('probe'),
                condition: jsPsych.timelineVariable('condition'),
                trial_part: 'probe'
            },
            on_finish : function(data) {
                if(data.key_press == 70) {
                    data.key_press_letter = 'i';
                }else{
                    data.key_press_letter = 'ie';
                }
                data.code = localStorage.getItem('accesscode');
            }
        };

        var pause = {
            type: 'html-keyboard-response',
            stimulus: '<p>Je mag even pauze nemen!</p>'+
                      '<p>Druk op <strong>spatie</strong> om verder te gaan</p>',
            choices: ['space'],
            post_trial_gap: 500,
            response_ends_trial: true,
            data: {
                target: jsPsych.timelineVariable('target'),
                probe: jsPsych.timelineVariable('probe'),
                condition: jsPsych.timelineVariable('condition'),
                trial_part: 'pause'
            }
        };

        for (var i = 0; i < numberOfTrials; i++) {
            var test1 = {
            timeline: [fixation, target, probe],
            timeline_variables: test_stim_temp[i],
            };
            timeline.push(test1);
            if (i < numberOfTrials - 1){
                timeline.push(pause);
            }
        }

        var end_screen = {
            type: 'html-keyboard-response',
            stimulus:   '<p>Hartelijk dank om deel te nemen aan het experiment.</p>'+
                        '<div style="max-width:675px;"><p><b>BELANGRIJK:</b> Druk op <b>spatie</b> om je data op te slaan en wacht tot je naar een volgend scherm wordt genavigeerd. Zodra je op die nieuwe pagina bent, mag je het experiment en de browser afsluiten.</p></div>',
            show_clickable_nav: true, 
            choices: ['space']
        };
        timeline.push(end_screen);

        jsPsych.init({
            timeline: timeline,
            preload_audio: all_audio,
            show_preload_progress_bar: true,
            use_webaudio: false,
            override_safe_mode: true,
            on_finish: function() {
                jsPsych.data.displayData();
                // var data = jsPsych.data.get();
                // data = data.filter({trial_part: "probe"});
                // data = data.ignore('internal_node_id');
                // data = data.ignore('probe');
                // data = data.ignore('stimulus');
                // data = data.ignore('trial_index');
                // data = data.ignore('trial_part');
                // data = data.ignore('trial_type');
                // json = data.json();
                // var userdata = localStorage.getItem('userdata');
                // console.log(userdata);
                // sendData(userdata, 'userdata')
                // sendData(json, 'testdata');
            }
        })
    </script>
</html>